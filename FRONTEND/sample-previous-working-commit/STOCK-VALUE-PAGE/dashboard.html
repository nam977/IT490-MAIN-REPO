<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Awesome Stock Trader Dashboard</title>
</head>
<body>
    <h1>My Awesome Stock Trader Dashboard</h1>

    <div id="flashContainer" class="flash-container"></div>

    <section class="cash-metrics">
        <div class="starting-cash-metric">
            <strong>Starting Cash</strong>
            <span id="startingCash">$0.00</span>
        </div>
        <div class="balance-cash-metric">
            <strong>Cash Balance</strong>
            <span id="cashBalance">$0.00</span>
        </div>
        <div class="holding-cash-metric">
            <strong>Holdings Value</strong>
            <span id="holdingsValue">$0.00</span>
        </div>
        <div class="equity-cash-metric">
            <strong>Total Equity</strong>
            <span id="totalEquity">$0.00</span>
        </div>
    </section>

    <form id="tradeForm">
        <h2>Submit Trade</h2>

        <label for="tickerSymbol">Ticker Symbol</label>
        <input id="tickerSymbol" name="tickerSymbol" 
               placeholder="e.g. AAPL" required>

        <label for="shareQuantity">Shares</label>
        <input id="shareQuantity" name="shareQuantity" 
               type="number" min="1" value="1" required>

        <label for="stockAction">Stock Action</label>

        <select id="stockAction" name="stockAction" required>
            <option value="">Selectâ€¦</option>
            <option value="stockBuy">Buy Stocks</option>
            <option value="stockSell">Sell Stocks</option>
        </select>

        <button type="submit">Submit Transaction</button>
    </form>

    
    <h2>Current Stock Assets</h2>
    <table>
        <thead>
            <tr>
                <th>Stock Symbol</th>
                <th>Stock Shares</th>
                <th>Average Stock Cost</th>
                <th>Last Trade Price</th>
                <th>Stock Market Value</th>
            </tr>
        </thead>
        <tbody id="holdingsBody">
            <tr>
                <td colspan="5">LOADING...</td>
            </tr>
        </tbody>
    </table>

    <h2>Recent Stock Transactions</h2>
    <table>
        <thead>
            <tr>
                <th>Purchase Timestamp</th>
                <th>Purchase Action</th>
                <th>Stock Symbol</th>
                <th>Stock Shares</th>
                <th>Stocok Price</th>
            </tr>
        </thead>
        <tbody id="tradesBody">
            <tr>
                <td colspan="5">LOADING...</td>
            </tr>
        </tbody>
    </table>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const sessionId = sessionStorage.getItem("session_id");
            const authToken = sessionStorage.getItem("auth_token");

            if(!sessionId || !authToken){
                window.location.href ="/login.html";
                return;
            }

            const flashContainer = document.getElementById("flashContainer");
            const startingCashElem = document.getElementById("startingCash");
            const cashBalanceElem = document.getElementById("cashBalance");
            const holdingsValueElem = document.getElementById("holdingsValue");
            const totalEquityElem = document.getElementById("totalEquity");
            const holdingsBody = document.getElementById("holdingsBody");
            const tradesBody = document.getElementById("tradesBody");
            const tradeForm = document.getElementById("tradeForm");

            function formatMoney(value){
                if (typeof value !== "number") return "$0.00";
                return `$${value.toFixed(2)}`;
            }

            function clearFlash (){
                flashContainer.innerHTML = "";
            }

            function addFlash(message, category = "info"){
                const div = document.createElement("div");
                div.className = `flash-message ${category}`;
                div.textContent = message;
                flashContainer.appendChild(div);
            }

            async function callGateway(payload){
                const response = await fetch("/mqGateway.php", {
                    method: "POST",
                    headers: { "Content-Type": "application/json"},
                    credentials: "same-origin",
                    body: JSON.stringify({
                        session_id: sessionId,
                        auth_token: authToken,
                        ...payload
                    })
                });
                return response.json();
            }

            async function loadPortfolio() {
                try {
                    const data = await callGateway ({ type: "get_portfolio" });
                    console.log("Portfolio data:", data);

                    clearFlash();

                    if (data.flash && Array.isArray(data.flash)) {
                        data.flash.forEach(f => 
                            addFlash(f.message, f.category)
                        );
                    }

                    if (data.status !== "success"){
                        addFlash(data.error || data.message || 
                                 "Failed to load portfolio", "error");
                        return;
                    }

                    startingCashElem.textContent = 
                        formatMoney(data.starting_cash);

                    cashBalanceElem.textContent = 
                        formatMoney(data.cash_balance);

                    holdingsValueElem.textContent = 
                        formatMoney(data.holdings_value);

                    totalEquityElem.textContent = 
                        formatMoney(data.total_equity);

                    holdingsBody.innerHTML = "";

                    if (data.holdings && data.holdings.length > 0){
                        data.holdings.forEach(h => {
                            const row = document.createElement("tr");
                            row.innerHTML = `
                                <td>${h.stock_symbol}</td>
                                <td>${h.stock_shares}</td>
                                <td>${formatMoney(h.avg_stock_cost)}</td>
                                <td>${formatMoney(h.last_trade_price)}</td>
                                <td>${formatMoney(h.stock_market_value)}</td>
                            `;
                            holdingsBody.appendChild(row);
                        });
                    } else {
                        const tr = document.createElement("tr");
                        tr.innerHTML = `<td colspan="5">No holdings found.</td>`;
                        holdingsBody.appendChild(tr);
                    }

                    stockTradesBody.innerHTML = "";

                    if (data.trades && data.trades.length > 0){
                        data.trades.forEach(t => {
                            const row = document.createElement("tr");
                            row.innerHTML = `
                                <td>${t.purchase_timestamp}</td>
                                <td>${t.purchase_action}</td>
                                <td>${t.stock_symbol}</td>
                                <td>${t.stock_shares}</td>
                                <td>${formatMoney(t.stock_price)}</td>
                            `;
                            stockTradesBody.appendChild(row);
                        });
                    } else {
                        const tr = document.createElement("tr");
                        tr.innerHTML = `<td colspan="5">No trades found.</td>`;
                        stockTradesBody.appendChild(tr);
                    }
                } catch (error) {
                    console.error("Error loading portfolio:", error);
                    clearFlash();
                    addFlash("Error loading portfolio data.", "error");
                }
            }

            tradeForm.addEventListener("submit", async(e) => {
                e.preventDefault();
                clearFlash();

                const symbol = 
                    document.getElementById("tickerSymbol").value.trim();
                
                const shares = 
                    Number(document.getElementById("shareQuantity").value);

                const action = document
                    .getElementById("stockAction").value;

                if (!symbol || !quantity || !action){
                    addFlash("Please fill in all trade form fields.", "error");
                    return;
                }

                try {
                    const data = await callGateway({
                        type:"place_stock_trade",
                        symbol,
                        shares,
                        action
                    });
                    console.log("Trade response:", data);

                    if (data.status === "success"){
                        addFlash(data.message || "Trade executed successfully.", 
                                 "success");
                                 await loadPortfolio();
                    } else {
                        addFlash(data.error || data.message || 
                                 "Failed to execute trade.", "error");
                    }
                } catch (error) {
                    console.error("Error placing trade:", error);
                    addFlash("Error placing trade.", "error");
                }
            });

            loadPortfolio();
        });
    </script>
</body>
</html>
